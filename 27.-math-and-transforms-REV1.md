---
id: 27
title: 27. Math & Transforms in Verse (Revised) — Safe Normalization, Projection, and Lerp
tags: [verse, math, vectors, transforms, normalize, dot, lerp, clamp]
summary: Revised math helpers for Verse with zero-guards, projection, and linear interpolation; examples are small, pure, and ready for finetuning.
---

# Math & Transforms (Revised)

This revision adds **projection** and **linear interpolation (lerp)** while keeping helpers **pure** and **guarded** against divide-by-zero.

> Rule of thumb: compute into locals first, then apply effects. Every division or normalization gets a **zero-length guard**.

---

## 1) Core Vector Helpers (Pure)

```verse
Add(A : vector3, B : vector3) : vector3 =
    return vector3{X := A.X + B.X, Y := A.Y + B.Y, Z := A.Z + B.Z}

Sub(A : vector3, B : vector3) : vector3 =
    return vector3{X := A.X - B.X, Y := A.Y - B.Y, Z := A.Z - B.Z}

Scale(V : vector3, S : float) : vector3 =
    return vector3{X := V.X * S, Y := V.Y * S, Z := V.Z * S}
```

---

## 2) Length, Distance, Dot (with unit clarity)

```verse
Length(V : vector3) : float =
    return Sqrt(V.X*V.X + V.Y*V.Y + V.Z*V.Z)

Distance(A : vector3, B : vector3) : float =
    return Length(Sub(B, A))

Dot(A : vector3, B : vector3) : float =
    return A.X*B.X + A.Y*B.Y + A.Z*B.Z
```

- Prefer explicit units in variable names, e.g., `StepMeters`, `Seconds`.

---

## 3) Normalize (Zero Guard)

```verse
Normalize(V : vector3) : vector3 =
    L := Length(V)
    if (L = 0.0):
        return vector3{X:=0.0, Y:=0.0, Z:=0.0}
    return vector3{X:=V.X / L, Y:=V.Y / L, Z:=V.Z / L}
```

---

## 4) Projection and Rejection

Project vector **A** onto **B**; also compute the **rejection** (A without the B component).

```verse
Project(A : vector3, B : vector3) : vector3 =
    BL := Length(B)
    if (BL = 0.0):
        return vector3{X:=0.0, Y:=0.0, Z:=0.0}
    NB := vector3{X:=B.X / BL, Y:=B.Y / BL, Z:=B.Z / BL}
    return Scale(NB, Dot(A, NB))

Reject(A : vector3, B : vector3) : vector3 =
    return Sub(A, Project(A, B))
```

---

## 5) Linear Interpolation (Lerp)

```verse
Lerp(A : vector3, B : vector3, T : float) : vector3 =
    # Clamp T to [0,1] for safety
    CT := (T < 0.0) ? 0.0 : ((T > 1.0) ? 1.0 : T)
    return Add(Scale(A, 1.0 - CT), Scale(B, CT))
```

- Lerp gives a point **between** A and B. Pair with effects (teleport/move) elsewhere.

---

## 6) Worked Example — Aim Line & Offset

```verse
AimLineAndOffset(Src : fort_character, Dst : fort_character) : void =
    S := Src.GetTransform().Translation
    D := Dst.GetTransform().Translation
    AB := Sub(D, S)
    Forward := Normalize(AB)
    Along := Project(AB, Forward)         # same as AB, shown for teaching
    Side  := Reject(AB, Forward)          # lateral offset component
    Print("[Aim] forward={Forward} side_len={Length(Side)}")
```

- Demonstrates project/reject and normalization with guards.

---

## 7) Finetuning Notes (LLM)

- Keep helpers **pure** and names **descriptive**.
- Always show a zero-length guard near normalization/projection.
- Provide one compact “worked example” that logs derived values.
