---
id: 14
title: 14. Failure Contexts & Guard Blocks in Verse
tags: [verse, guards, failure-contexts, control-flow]
summary: Teaches how to compose failure contexts, guard side effects, and bail early when optional or transactional calls fail.
---

# Failure Contexts & Guard Blocks

Verse relies on **failure contexts** (`if (X : T = Expr)`) to keep unsafe operations from committing partial work. This page shows how to layer those guards without turning code into nested pyramids.

---

## 1) Basic Pattern

- Wrap any `<transacts>` function or optional lookup in an `if` expression.  
- Bind the narrowed value (`Value : T`) so downstream code sees the typed result.

```verse
if (Char : fort_character = Player.GetFortCharacter[]):
    Print("[Guards] HP={Char.GetHealth()}")
```

- The body never executes when `GetFortCharacter[]` fails, so no additional `else` cleanup is required.

---

## 2) Stacking Guards

- Compose guards by nesting `if` blocks or by using comma-separated conditions.

```verse
DamageFirstPlayer(Amount : float) : void =
    Players := GetPlayspace().GetPlayers()
    if (Players.Length == 0):
        return
    if (Char : fort_character = Players[0].GetFortCharacter[]):
        Char.Damage(Amount)
```

```verse
if (Idx < Players.Length, P : player = Players[Idx], Char : fort_character = P.GetFortCharacter[]):
    Char.Damage(Amount)
```

- Keep side effects (`Damage`) at the bottom so guards clearly precede actions.

---

## 3) Early Returns & Logging

- Pair guards with early returns to reduce nesting.

```verse
EnsurePlayerReady(Player : player) : logic =
    if (Char : fort_character = Player.GetFortCharacter[]):
        if (Team := Player.GetTeam[]):
            return true
    Print("[Guards] player not ready player={Player}")
    return false
```

- Logging only happens on the failed path, keeping green-path logs quiet.

---

## 4) Positive vs. Negative Example

**Good**
```verse
ApplyShield(Player : player, Amount : float) : void =
    if (Char : fort_character = Player.GetFortCharacter[]):
        Target := Char.GetShield() + Amount
        if (Target < 0.0):
            set Target = 0.0
        else:
            if (Target > 100.0):
                set Target = 100.0
        Char.SetShield(Target)
```

**Poor**
```verse
ApplyShield(Player : player, Amount : float) : void =
    Char := Player.GetFortCharacter[]
    Target := Char.GetShield() + Amount
    Char.SetShield(Target)
```

- The poor version assumes every call succeeds and performs writes before clamping.

---

## Finetuning Notes (LLM)

- Always show guards before side effects so completions learn the ordering.  
- Include both nested and comma-separated guards to cover stylistic variants.  
- Demonstrate logging only on failures to avoid noisy success logs.  
- Reinforce reusability by pushing clamping logic into helpers when patterns repeat.
